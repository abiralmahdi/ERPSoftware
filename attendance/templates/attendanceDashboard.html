{% extends 'layout.html' %}
{% block body %}

<style>
    .card {
        margin-bottom: 20px;
    }
    .card-title {
        font-size: 1.25rem;
        margin-bottom: 15px;
    }
</style>

<div class="mx-5 mt-5 pt-4">
    <div class="row">
        <div class="col-md-6">
            <div class="d-flex mb-2 gap-2">
                <h6 class="h6 mt-2" id="quickViewTitle">Overall</h6>
                <input type="text" id="quickViewName" placeholder="Search by name" class="form-control form-control-sm" style="width: 150px;">
            
                <select id="quickViewDepartment" class="form-control form-control-sm" style="width: 110px;">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                    <option value="{{ dept.name }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            
                <select id="quickViewStatus" class="form-control form-control-sm" style="width: 110px;">
                    <option value="">All Status</option>
                    <option value="present">Present</option>
                    <option value="absent">Absent</option>
                    <option value="leave">Leave</option>
                </select>
            
                <input type="date" id="quickViewStartDate" class="form-control form-control-sm" style="width: 130px;">
                <input type="date" id="quickViewEndDate" class="form-control form-control-sm" style="width: 130px;">

                <a href="/attendance/scanAttendance" class="btn btn-dark"><i class="fa-solid me-2 fa-clipboard-user"></i>Update Attendance</a>
            </div>
        <div class="table-responsive" style="max-height: 330px; overflow-y: auto;">
            <table class="table table-striped table-hover table-sm">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 2;">
                    <tr>
                        <th>#</th>
                        <th>Employee Name</th>
                        <th>Designation</th>
                        <th>Department</th>
                        <th>Date</th>
                        <th>In Time</th>
                        <th>Out Time</th>
                        <th>Remote</th>
                        <th>Reason</th>
                        <th>Location</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="quickViewTableBody">
                    {% for attn in attendances %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ attn.employee.user.get_full_name }}</td>
                        <td>{{ attn.employee.designation.title }}</td>
                        <td>{{ attn.employee.department.name }}</td>
                        <td>{{ attn.date }}</td>
                        <td>{{ attn.inTime }}</td>
                        <td>{% if attn.outTime %}{{ attn.outTime }}{% endif %}</td>
                        <td>
                            {% if attn.remote %} 
                                <i class="fa-solid text-success fa-check ms-3"></i>
                            {% else %} 
                                <i class="fa-solid text-danger fa-xmark ms-3"></i>
                            {% endif %}
                        </td>
                        <td>{{attn.reason}}</td>
                        <td>{{attn.location}}</td>
                        <td>
                            {% if attn.date|date:"l" == globalConfig.weekend and attn.inTime %}
                                <span class="badge bg-info">Present - Weekend</span>
                            {% elif attn.inTime <= globalConfig.officeStartTime or not attn.inTime %}
                                <span class="badge bg-{% if attn.status == 'present' %}success{% elif attn.status == 'leave' %}warning{% else %}danger{% endif %}">{{attn.status}}</span>
                            {% else %}
                                <span class="badge text-dark" style="background-color: rgb(164, 242, 156) !important;">late</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center">No Attendance Records found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>

        <div class="col-md-6">
            <div class="table-responsive" style="max-height: 355px; overflow-y: auto;">
                <!-- Make filter header sticky -->
                <div class="card-header d-flex justify-content-between align-items-center sticky-top bg-white" style="top: 0; z-index: 3;">
                    <h6 class="mb-0" id="absentEmployeesTitle">Absent Employees</h6>
                    <input type="text" id="filterName" placeholder="Search by name" class="form-control form-control-sm" style="width: 250px;">
        
                    <select id="filterDepartment" class="form-control form-control-sm" style="width: 150px;">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{dept.name}}">{{dept.name}}</option>
                        {% endfor %}
                    </select>
                    
                    <input type="date" id="absentDate" class="form-control form-control-sm" style="width: 150px;">
                </div>
        
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light position-sticky top-0" style="z-index: 2;">
                        <tr>
                            <th>#</th>
                            <th>Employee Name</th>
                            <th>Department</th>
                            <th>Designation</th>
                        </tr>
                    </thead>
                    <tbody id="absentTableBody">
                        {% for absentee in absentees %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ absentee.user.get_full_name }}</td>
                            <td>{{ absentee.department.name }}</td>
                            <td>{{ absentee.designation.title }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="text-center">No absent employees found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        
    </div>
    <div class="row mt-3" style="height: 400px;">
        <div class="col-12">
            <div class="card shadow-sm" style="height: 100%;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Attendance Distribution</h5>
                    <div class="d-flex gap-2">
                        <p class="d-flex mb-0">
                            <span id="totalLateHours" style="width: 200px !important;">Total Late Hours: 0</span>
                            <span id="totalAbsentHours" style="width: 200px !important;">Total Absent Hours: 0</span>
                            <span id="totalWorkingHours" style="width: 200px !important;">Total Working Hours: 0</span>
                        </p>
                        <input type="date" id="startDate" class="form-control form-control-sm">
                        <input type="date" id="endDate" class="form-control form-control-sm">
                    </div>
                </div>
                <style>
                    #attendanceChart {
                        width: 100% !important;
                        max-width: 100% !important;
                    }
                </style>
                <div class="card-body" style="height: 325px;">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    

    
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
    const dateInput = document.getElementById("absentDate");
    const deptInput = document.getElementById("filterDepartment");
    const nameInput = document.getElementById("filterName");
    const tableBody = document.getElementById("absentTableBody");

    function loadAbsentees() {
        const pickedDate = dateInput.value;
        const department = deptInput.value;
        const name = nameInput.value;

        if (!pickedDate) return;

        const params = new URLSearchParams({
            date: pickedDate,
            department: department,
            name: name
        });

        fetch(`/attendance/get-absentees/?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                tableBody.innerHTML = "";
                if (data.absentees.length > 0) {
                    data.absentees.forEach((emp, index) => {
                        const row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${emp.name}</td>
                                <td>${emp.department}</td>
                                <td>${emp.designation}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                    document.getElementById('absentEmployeesTitle').innerHTML = `Absent Employees (${data.absentees.length})`
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center">No absent employees found.</td>
                        </tr>
                    `;
                }
            })
            .catch(err => {
                console.error(err);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">Error loading data</td>
                    </tr>
                `;
            });
    }

    // Set today's date and restrict future dates
    const today = new Date().toISOString().split("T")[0];
    dateInput.value = today;
    dateInput.setAttribute("max", today);

    // Load initial data
    loadAbsentees();

    // Event listeners for all filters
    dateInput.addEventListener("change", loadAbsentees);
    deptInput.addEventListener("change", loadAbsentees);
    nameInput.addEventListener("input", loadAbsentees);
});



    </script>
    

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const startInput = document.getElementById("startDate");
            const endInput = document.getElementById("endDate");
            const officeStartTime = "{{ globalConfig.officeStartTime|date:'H:i' }}"; // HH:MM
        
            const today = new Date();
            const todayStr = today.toISOString().split("T")[0];
            startInput.max = todayStr;
            endInput.max = todayStr;
        
            const last30 = new Date();
            last30.setDate(today.getDate() - 30);
            const last30Str = last30.toISOString().split("T")[0];
        
            startInput.value = last30Str;
            endInput.value = todayStr;
        
            const ctx = document.getElementById("attendanceChart").getContext("2d");
            let attendanceChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [],
                    datasets: [
                        { label: "Present", data: [], backgroundColor: "#28a745", stack: "attendance" },
                        { label: "Weekend Present", data: [], backgroundColor: "#03f0fc", stack: "attendance" },
                        { label: "Late", data: [], backgroundColor: "#20c997", stack: "attendance" },
                        { label: "Absent", data: [], backgroundColor: "#dc3545", stack: "attendance" },
                        { label: "Leave", data: [], backgroundColor: "#ffc107", stack: "attendance" }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: "top" } },
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true, beginAtZero: true }
                    }
                }
            });
        
            function fetchAttendanceData(start, end) {
                if (!start || !end) return;
        
                fetch(`/attendance/attendance-data/?start=${start}&end=${end}&officeStartTime=${officeStartTime}`)
                    .then(res => res.json())
                    .then(data => {
                        // Update chart
                        attendanceChart.data.labels = data.labels;
        
                        // Note: `present` includes late, so subtract late to get "on-time present"
                        attendanceChart.data.datasets[0].data = data.present.map((p, i) => p - data.late[i]); 
                        attendanceChart.data.datasets[1].data = data.weekend; // weekend present
                        attendanceChart.data.datasets[2].data = data.late; 
                        attendanceChart.data.datasets[3].data = data.absent;
                        attendanceChart.data.datasets[4].data = data.leave;
        
                        attendanceChart.update();
        
                        // === Update totals ===
                        const totalLateHours = data.total_late_hours.reduce((a, b) => a + b, 0);
                        const totalAbsentHours = data.total_absent_hours.reduce((a, b) => a + b, 0);
                        const totalWorkingHours = data.total_working_hours.reduce((a, b) => a + b, 0);
        
                        document.getElementById("totalLateHours").textContent = `Total Late Hours: ${totalLateHours}`;
                        document.getElementById("totalAbsentHours").textContent = `Total Absent Hours: ${totalAbsentHours}`;
                        document.getElementById("totalWorkingHours").textContent = `Total Working Hours: ${totalWorkingHours}`;
                    })
                    .catch(err => console.error("Error fetching attendance data:", err));
            }
        
            startInput.addEventListener("change", () => {
                if (startInput.value && endInput.value) fetchAttendanceData(startInput.value, endInput.value);
            });
        
            endInput.addEventListener("change", () => {
                if (startInput.value && endInput.value) fetchAttendanceData(startInput.value, endInput.value);
            });
        
            // Load initial data
            fetchAttendanceData(last30Str, todayStr);
        });
        </script>
        
        
        <script>
            document.addEventListener("DOMContentLoaded", function () {
    const nameInput = document.getElementById("quickViewName");
    const deptInput = document.getElementById("quickViewDepartment");
    const statusInput = document.getElementById("quickViewStatus");
    const startDateInput = document.getElementById("quickViewStartDate");
    const endDateInput = document.getElementById("quickViewEndDate");
    const tableBody = document.querySelector("#quickViewTableBody");
    const officeStartTime = "{{ officeStartTime }}";
    const weekend = "{{weekend}}"
    function loadQuickView() {
        const params = new URLSearchParams({
            name: nameInput.value,
            department: deptInput.value,
            status: statusInput.value,
            start_date: startDateInput.value,
            end_date: endDateInput.value
        });

        fetch(`/attendance/get-quickview/?${params.toString()}`)
            .then(res => res.json())
            .then(data => {
                tableBody.innerHTML = "";
                if (data.attendances.length > 0) {
                    data.attendances.forEach((attn, index) => {
                        const row = `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${attn.name}</td>
                                <td>${attn.designation}</td>
                                <td>${attn.department}</td>
                                <td>${attn.date}</td>
                                <td>${attn.in_time || ''}</td>
                                <td>${attn.out_time || ''}</td>
                                <td>${attn.remote 
                                    ? '<a href="/leave/visitApplications"><i class="fa-solid text-success fa-check ms-3"></i></a>'
                                    : '<i class="fa-solid text-danger fa-xmark ms-3"></i>'
                                }</td>
                                <td>${attn.reason || ''}</td>
                                <td>${attn.location || ''}</td>
                                <td>
                                    ${
                                        (() => {
                                            const dayName = new Date(attn.date).toLocaleDateString('en-US', { weekday: 'long' });
                                            if (dayName === weekend && attn.in_time) {
                                                return `<span class="badge bg-info">present-weekend</span>`;
                                            } else if (!attn.in_time || attn.in_time <= officeStartTime) {
                                                return `<span class="badge bg-${attn.status === 'present' ? 'success' : attn.status === 'leave' ? 'warning' : 'danger'}">${attn.status}</span>`;
                                            } else {
                                                return `<span class="badge text-dark" style="background-color: rgb(164, 242, 156) !important;">late</span>`;
                                            }
                                        })()
                                    }
                                </td>
                                
                            </tr>
                            `;
                            tableBody.innerHTML += row;
                            console.log(attn.in_time)
                            console.log(officeStartTime)
                    });
                    document.getElementById('quickViewTitle').innerHTML = `Overall (${data.attendances.length})`;
                } else {
                    tableBody.innerHTML = `<tr><td colspan="11" class="text-center">No Attendance Records found.</td></tr>`;
                }
            })
            .catch(err => {
                console.error(err);
                tableBody.innerHTML = `<tr><td colspan="11" class="text-center text-danger">Error loading data</td></tr>`;
            });
    }

    // Set default dates
    const today = new Date().toISOString().split("T")[0];
    startDateInput.value = today;
    endDateInput.value = today;
    startDateInput.setAttribute("max", today);
    endDateInput.setAttribute("max", today);

    // Initial load
    loadQuickView();

    // Event listeners
    nameInput.addEventListener("input", loadQuickView);
    deptInput.addEventListener("change", loadQuickView);
    statusInput.addEventListener("change", loadQuickView);
    startDateInput.addEventListener("change", loadQuickView);
    endDateInput.addEventListener("change", loadQuickView);
});

            </script>

{% endblock %}
