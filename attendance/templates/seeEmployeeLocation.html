{% extends 'layout.html' %}
{% block body %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<div class="container mt-5 pt-5" style="min-width: 1500px !important;">

    <div class="table-container">
        <table class="table table-striped">
            <thead class="sticky-header">
                <tr>
                    <th>Name</th>
                    <th>Designation</th>
                    <th>Department</th>
                    <th>Latest Location</th>
                    <th>Timeastamp</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr>
                    <td>{{ emp.name }}</td>
                    <td>{{ emp.designation }}</td>
                    <td>{{ emp.department }}</td>
                    <td>{{ emp.location }}</td>
                    <td>{{ emp.date }} - {{ emp.time }}</td>
                    <td>
                        <button class="btn btn-dark btn-sm show-location-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#locationModal"
                            data-name="{{ emp.name }}"
                            data-lat="{{ emp.lat }}"
                            data-lon="{{ emp.lon }}"
                            data-location="{{ emp.location }}"
                            data-date="{{emp.date}}"
                            data-time="{{emp.time}}">
                            Show Location
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Employee Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="employeeName"></h6>
                <div id="map" style="height: 400px; border-radius: 8px;"></div>
                <p class="mt-3"><strong>Location:</strong> <span id="locationText"></span></p>
                <p class="mt-3"><strong>Time:</strong> <span id="timeText"></span></p>
            </div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />

<script>
let map, marker;

document.addEventListener("DOMContentLoaded", function () {
    const locationModal = document.getElementById("locationModal");

    locationModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const name = button.getAttribute("data-name");
        const lat = parseFloat(button.getAttribute("data-lat"));
        const lon = parseFloat(button.getAttribute("data-lon"));
        const location = button.getAttribute("data-location");
        const timestamp = button.getAttribute("data-date") + " - " + button.getAttribute("data-time");

        document.getElementById("employeeName").textContent = name;
        document.getElementById("locationText").textContent = location;
        document.getElementById("timeText").textContent = timestamp;

        const mapContainer = document.getElementById("map");

        if (!lat || !lon) {
            mapContainer.innerHTML = "<p class='text-danger'>No location available</p>";
            return;
        }

        // Initialize MapLibre GL JS map
        if (!map) {
            map = new maplibregl.Map({
                container: "map",
                style: "https://api.maptiler.com/maps/streets/style.json?key=bTM3XgZCdvXvDegFIcUs",
                center: [lon, lat],
                zoom: 15
            });

            map.addControl(new maplibregl.NavigationControl());

            // Marker
            marker = new maplibregl.Marker()
                .setLngLat([lon, lat])
                .setPopup(new maplibregl.Popup().setHTML(`<b>${name}</b><br>${location}`))
                .addTo(map);
        } else {
            // Update existing map
            map.setCenter([lon, lat]);
            map.setZoom(15);

            if (marker) {
                marker.setLngLat([lon, lat])
                      .setPopup(new maplibregl.Popup().setHTML(`<b>${name}</b><br>${location}`));
            }
        }

        // Resize map to fit modal
        locationModal.addEventListener('shown.bs.modal', () => {
            if (map) map.resize();
        });
    });
});
</script>

{% endblock %}
