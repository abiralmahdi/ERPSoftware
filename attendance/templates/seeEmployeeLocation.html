{% extends 'layout.html' %}
{% block body %}
<style>
thead.sticky-header th {
    position: sticky !important;
    top: 0 !important;
    background-color: #f8f9fa !important;
    z-index: 12 !important;
  }
.table-container, .table-responsive{
    max-height: 1000px !important;
    overflow-y: auto;
}
   /* Container adjustments for responsiveness */
@media (max-width: 1199px) {
  .container.mt-5.pt-5 {
    min-width: unset !important;
    width: 100% !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    box-sizing: border-box;
  }
  
}

/* Table container scroll with max height */
@media (max-width: 991px) {
  .table-container,
  .table-responsive {
    max-height: 850px;
    overflow-x: auto !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #ddd;
    border-radius: 6px;
  }

  table.table {
    min-width: 700px;
    width: 100%;
    font-size: 0.9rem;
    table-layout: auto;
  }

  table.table th,
  table.table td {
    white-space: nowrap;
    padding: 0.3rem 0.6rem;
    vertical-align: middle;
  }

  thead.sticky-header th {
    position: sticky !important;
    top: 0 !important;
    background-color: #f8f9fa !important;
    z-index: 12 !important;
  }
}

/* Buttons and controls stack on small screen */
@media (max-width: 575px) {
  .d-flex.mb-3.mt-5.pt-5 {
    flex-direction: column !important;
    gap: 10px;
  }

  .d-flex.mb-3.mt-5.pt-5 form.form.d-flex.me-auto input.form-control,
  .d-flex.mb-3.mt-5.pt-5 form.form.d-flex.me-auto select.btn,
  .d-flex.mb-3.mt-5.pt-5 form.form.d-flex.me-auto button.btn,
  .d-flex.mb-3.mt-5.pt-5 > button.btn.btn-dark.ms-auto {
    width: 100% !important;
    max-width: 100% !important;
  }

  .d-flex.mb-3.mt-5.pt-5 > button.btn.btn-dark.ms-auto {
    margin-top: 8px;
  }

  table.table {
    min-width: 480px;  /* reduce min-width for phones */
    font-size: 0.85rem !important;
  }

  table.table th,
  table.table td {
    padding: 0.2rem 0.4rem !important;
  }
}

/* Modal responsiveness */

@media (max-width: 991px) {
  .modal-xl {
    max-width: 95vw !important;
    margin: 1rem auto;
  }
  #map {
    height: 300px !important;
  }
}

@media (max-width: 575px) {
  .modal-xl {
    max-width: 98vw !important;
  }
  #map {
    height: 250px !important;
  }
}

</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<div class="container mt-5 pt-5">

    <div class="table-container">
        <table class="table table-striped">
            <thead class="sticky-header">
                <tr>
                    <th>Name</th>
                    <th>Designation</th>
                    <th>Department</th>
                    <th>Latest Location</th>
                    <th>Timeastamp</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for emp in employees %}
                <tr>
                    <td>{{ emp.name }}</td>
                    <td>{{ emp.designation }}</td>
                    <td>{{ emp.department }}</td>
                    <td>{{ emp.location }}</td>
                    <td>{{ emp.date }} - {{ emp.time }}</td>
                    <td>
                        <button class="btn btn-dark btn-sm show-location-btn"
                            data-bs-toggle="modal"
                            data-bs-target="#locationModal"
                            data-name="{{ emp.name }}"
                            data-lat="{{ emp.lat }}"
                            data-lon="{{ emp.lon }}"
                            data-location="{{ emp.location }}"
                            data-date="{{emp.date}}"
                            data-time="{{emp.time}}">
                            Show Location
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Employee Location</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="employeeName"></h6>
                <div id="map" style="height: 400px; border-radius: 8px;"></div>
                <p class="mt-3"><strong>Location:</strong> <span id="locationText"></span></p>
                <p class="mt-3"><strong>Time:</strong> <span id="timeText"></span></p>
            </div>
        </div>
    </div>
</div>
<script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
<link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />

<script>
let map, marker;

document.addEventListener("DOMContentLoaded", function () {
    const locationModal = document.getElementById("locationModal");

    locationModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const name = button.getAttribute("data-name");
        const lat = parseFloat(button.getAttribute("data-lat"));
        const lon = parseFloat(button.getAttribute("data-lon"));
        const location = button.getAttribute("data-location");
        const timestamp = button.getAttribute("data-date") + " - " + button.getAttribute("data-time");

        document.getElementById("employeeName").textContent = name;
        document.getElementById("locationText").textContent = location;
        document.getElementById("timeText").textContent = timestamp;

        const mapContainer = document.getElementById("map");

        if (!lat || !lon) {
            mapContainer.innerHTML = "<p class='text-danger'>No location available</p>";
            return;
        }

        // Initialize MapLibre GL JS map
        if (!map) {
            map = new maplibregl.Map({
                container: "map",
                style: "https://api.maptiler.com/maps/streets/style.json?key=bTM3XgZCdvXvDegFIcUs",
                center: [lon, lat],
                zoom: 15
            });

            map.addControl(new maplibregl.NavigationControl());

            // Marker
            marker = new maplibregl.Marker()
                .setLngLat([lon, lat])
                .setPopup(new maplibregl.Popup().setHTML(`<b>${name}</b><br>${location}`))
                .addTo(map);
        } else {
            // Update existing map
            map.setCenter([lon, lat]);
            map.setZoom(15);

            if (marker) {
                marker.setLngLat([lon, lat])
                      .setPopup(new maplibregl.Popup().setHTML(`<b>${name}</b><br>${location}`));
            }
        }

        // Resize map to fit modal
        locationModal.addEventListener('shown.bs.modal', () => {
            if (map) map.resize();
        });
    });
});
</script>

{% endblock %}
