{% extends 'layout2.html' %}
{% load fileBaseName %}
{% block body %}
<style>
    .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 2;
        background-color: #f8f9fa;
    }
    .table th, .table td {
        padding-top: 0.3rem;
        padding-bottom: 0.3rem;
    }
</style>



<div class="container" style="margin-top: 80px; min-width: 1600px">
    <div class="d-flex mb-3">
        <form class="form d-flex flex-wrap" method="GET" action="">
            <!-- Search Input -->
            <input type="text" class="form-control mb-2 me-2"
                   style="height: 40px; width: 280px;"
                   name="search" placeholder="Search (Scope, Note...)"
                   value="{{ request.GET.search }}">
        
            <!-- Customer Dropdown -->
            <select name="customer" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
                <option value="">All Customers</option>
                {% for c in customers %}
                    <option value="{{ c.id }}" {% if request.GET.customer == c.id|stringformat:"s" %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                {% endfor %}
            </select>
        
            <!-- Agent Dropdown -->
            <select name="agent" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
                <option value="">All Contact Persons</option>
                {% for a in agents %}
                    <option value="{{ a.id }}" {% if request.GET.agent == a.id|stringformat:"s" %}selected{% endif %}>
                        {{ a.agent_name }}
                    </option>
                {% endfor %}
            </select>
        
            <!-- Market Persons (Lead Generator) -->
            <select name="marketPersons" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
                <option value="">All Market Persons</option>
                {% for e in employees %}
                    <option value="{{ e.id }}" {% if request.GET.marketPersons == e.id|stringformat:"s" %}selected{% endif %}>
                        {{ e.user.get_full_name }}
                    </option>
                {% endfor %}
            </select>
        
            <!-- AssignedTo (Sales Person) -->
            <select name="employee" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
                <option value="">All Sales Persons</option>
                {% for e in employees %}
                    <option value="{{ e.id }}" {% if request.GET.employee == e.id|stringformat:"s" %}selected{% endif %}>
                        {{ e.user.get_full_name }}
                    </option>
                {% endfor %}
            </select>
        
            <!-- Date Filters -->
            <input type="date" name="start_date" class="form-control mb-2 me-2"
                   style="height:40px; width: 180px"
                   value="{{ request.GET.start_date }}">
            <input type="date" name="end_date" class="form-control mb-2 me-2"
                   style="height:40px; width: 180px"
                   value="{{ request.GET.end_date }}">
        
            <!-- Filter Button -->
            <button type="submit" class="btn btn-dark mb-2">Filter</button>
        </form>        
    </div>

    <div class="table-container" style="max-height: 650px; overflow-y: auto;">
        
<table class="table table-striped">
    <thead class="">
        <tr>
            <th>ID</th>
            <th>Offered Date</th>
            <th>Customer</th>
            <th>Contact Person</th>
            <th>Lead Generated By</th>
            <th>Offer Assigned To</th>
            <th>PO Ref</th>
            <th>Order Value</th>
            <th>Advance Payment</th>
            <th>Delivery Date</th>
            <th>Status</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
    {% for order in orders %}
        <tr>
            <td>{{ order.id }}</td>
            <td>{{ order.offer.offer_date }}</td>
            {% if order.offer.lead.customerVisit %}
            <td>{{order.offer.lead.customerVisit.customer.name}}</td>
            <td>{{order.offer.lead.customerVisit.agent.agent_name}}</td>
            <td>{{order.offer.lead.customerVisit.employee.user.get_full_name}}</td>
            {% else %}
            <td>{{order.offer.lead.customer.name}}</td>
            <td>{{order.offer.lead.agent.agent_name}}</td>
            <td>{{order.offer.lead.employee.user.get_full_name}}</td>
            {% endif %}
            <td>{{order.offer.lead.assignedTo.user.get_full_name}}</td>
            <td>{{ order.poRef }}</td>
            <td>{{ order.order_value }}</td>
            <td>{{ order.advance_payment }}</td>
            <td>{{ order.delivery_date }}</td>
            <td>
                <span class="text-{% if order.is_overdue %}danger fw-bold{% endif %}">{{ order.status }}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#editOrderModal{{ order.id }}">
                    View
                </button>
            </td>
        </tr>

        <!-- Modal -->
        <div class="modal fade" id="editOrderModal{{ order.id }}" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <form method="POST" enctype="multipart/form-data" action="/crm/editOrder/{{order.id}}">
                {% csrf_token %}
                <div class="modal-header">
                  <h5 class="modal-title">Edit Order #{{ order.id }}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- Offer Info (readonly) -->
                    <h6>Offer Info</h6>
                    <div class="mb-2">
                        <label class="form-label">Offer Submission Date</label>
                        <input type="text" class="form-control" value="{{ order.offer.lead.offerSubmissionDate }}" readonly>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Negotiation Date</label>
                        <input type="text" class="form-control" value="{{ order.offer.negoDate }}" readonly>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Target Price</label>
                        <input type="text" class="form-control" value="{{ order.offer.tgtPrice }}" readonly>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Offer Value</label>
                        <input type="text" class="form-control" value="{{ order.offer.offerValue }}" readonly>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Discount</label>
                        <input type="text" class="form-control" value="{{ order.offer.discount }}" readonly>
                    </div>



                    <hr>

                    <!-- Order Info (editable) -->
                    <h6>Order Info</h6>
                    <div class="mb-2">
                        <label class="form-label">Delivery Date</label>
                        <input type="date" name="delivery_date" value="{{ order.delivery_date|date:'Y-m-d' }}" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-control">
                            <option value="Pending" {% if order.status == "Pending" %}selected{% endif %}>Pending</option>
                            <option value="Partial Delivered" {% if order.status == "Partial Delivered" %}selected{% endif %}>Partial Delivered</option>
                            <option value="Delivered" {% if order.status == "Delivered" %}selected{% endif %}>Delivered</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Advance Payment</label>
                        <input type="number" step="0.01" name="advance_payment" value="{{ order.advance_payment }}" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">PO Reference</label>
                        <input type="text" name="poRef" value="{{ order.poRef }}" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Order Value</label>
                        <input type="number" step="0.01" name="order_value" value="{{ order.order_value }}" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Note</label>
                        <textarea name="note" class="form-control">{{ order.note }}</textarea>
                    </div>

                    <!-- Files -->
                    <h6>Order Files</h6>
                    <div class="mb-2">
                        <input type="file" name="order_files" multiple class="form-control">
                    </div>
                    <div class="d-flex">
                        {% for f in order.orderFile.all %}
                            <div class="mx-1">
                                <a href="{{ f.file.url }}" target="_blank" class="btn btn-sm btn-outline-dark">
                                    <i class="fa fa-file"></i> {{ f.file|filename }}
                                </a>
                            </div>
                        {% empty %}
                            <p class="text-muted">No files uploaded</p>
                        {% endfor %}
                    </div>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-success">Save changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>

    {% endfor %}
    </tbody>
</table>

    </div>
</div>

{% endblock %}
