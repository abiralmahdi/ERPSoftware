{% extends 'layout2.html' %}
{% block body %}
<div class="container mt-5" style="min-width: 1600px !important">
    <div class="d-flex mb-3 mt-5 pt-5">
        <form class="form d-flex me-auto align-items-center" method="POST">
            {% csrf_token %}
            <input type="hidden" name="search_form" value="1">
    
            <!-- Employee Search -->
            <input type="text" class="form-control me-2" style="height: 40px; width: 400px;" 
                   name="employeeSearch" placeholder="Search employees..." 
                   value="{{ request.POST.employeeSearch }}">
    
            <!-- Date Filters -->
            <label class="ms-2 me-1">From:</label>
            <input type="date" class="form-control me-2" name="startDateFilter"
                   value="{{ request.POST.startDateFilter }}">
    
            <label class="ms-2 me-1">To:</label>
            <input type="date" class="form-control me-2" name="endDateFilter"
                   value="{{ request.POST.endDateFilter }}">
    
            <button type="submit" class="btn btn-dark">Filter</button>
        </form>
    
        <button class="btn btn-dark ms-auto" data-bs-toggle="modal" data-bs-target="#applyVisitModal">
            <i class="fa-solid fa-plus me-2"></i>Apply
        </button>
        <button class="btn btn-dark ms-3" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
            <i class="fa-solid fa-plus me-2"></i>Add Customer
        </button>
    </div>
    

    <div class="row">
        <div class="col-md-12 table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-striped table-hover">
                <thead class="table-light position-sticky top-0">
                    <tr>
                        <th>#</th>
                        <th>Employee Name</th>
                        <th>Department</th>
                        <th>Visit To</th>
                        <th>Start Date & Time</th>
                        <th>End Date & Time</th>
                        <th>Dept Approval</th>
                        <th>HR Approval</th>
                        <th>Final Approval</th>
                        <th>Remarks</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for application in customerVisits %}

                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ application.employee.user.get_full_name }}</td>
                            <td>{{ application.employee.department.name }}</td>
                            <td>
                                {{ application.customer.name }}
                                <span class="text-muted badge">{{ application.agent.agent_name }} - {{application.agent.agent_contact}}</span>
                            </td>
                            <td>{{ application.startDate }}</td>
                            <td>{{ application.endDate }}</td>

                            <!-- Dept Approval -->
                            <td>
                                
                                    {% if application.visit_application.deptApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.deptApprovedBy.user.get_full_name }}</span>
                                    {% elif application.visit_application.deptApproval == 'pending' %}
                                        <span class="badge bg-warning">Pending</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.deptApprovedBy.user.get_full_name }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.deptApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                            </td>

                            <!-- HR Approval -->
                            <td>
                               
                                    {% if application.visit_application.HRApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.HRApprovedBy.user.get_full_name }}</span>
                                    {% elif application.visit_application.HRApproval == 'pending' %}
                                        <span class="badge bg-warning">Pending</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.HRApprovedBy.user.get_full_name }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.HRApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                            </td>

                            <!-- Final Approval -->
                            <td>

                                    {% if application.visit_application.finalApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.finalApprovedBy.user.get_full_name }}</span>
                                    {% elif application.visit_application.finalApproval == 'pending' %}
                                        <span class="badge bg-warning">Pending</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.finalApprovedBy.user.get_full_name }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.visit_application.finalApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                            </td>


                            <!-- Remarks -->
                            <td>
                                {% if application.remarks %}
                                    <span class="bg-light text-dark" style="font-size: smaller;">{{ application.remarks }}</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">No remarks</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#viewModal{{ application.id }}">
                                    View
                                </button>
                                <!-- Modal for this application -->
                        <div class="modal fade" id="viewModal{{ application.id }}" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                <h5 class="modal-title">Customer Visits #{{ forloop.counter }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                <form action="/crm/completeVisit/{{application.id}}" method="POST">
                                    {% csrf_token %}
                                    <div class="mb-2">
                                    <label class="form-label">Employee</label>
                                    <input type="text" class="form-control" value="{{ application.employee.user.get_full_name }}" readonly>
                                    </div>
                                    <div class="mb-2">
                                    <label class="form-label">Department</label>
                                    <input type="text" class="form-control" value="{{ application.employee.department.name }}" readonly>
                                    </div>
                                    <div class="mb-2">
                                    <label class="form-label">Customer</label>
                                    <input type="text" class="form-control" value="{{ application.customer.name }}" readonly>
                                    </div>
                                    <div class="mb-2">
                                    <label class="form-label">Agent</label>
                                    <input type="text" class="form-control" value="{{ application.agent.agent_name }} - {{ application.agent.agent_contact }}" readonly>
                                    </div>
                                    <div class="row">
                                    <div class="col mb-2">
                                        <label class="form-label">Start</label>
                                        <input type="text" class="form-control" value="{{ application.startDate }}" readonly>
                                    </div>
                                    <div class="col mb-2">
                                        <label class="form-label">End</label>
                                        <input type="text" class="form-control" value="{{ application.endDate }}" readonly>
                                    </div>
                                    </div>
                                    <div class="row">
                                    <div class="col mb-2">
                                        <label class="form-label">Dept Approval</label>
                                        <input type="text" class="form-control" value="{{ application.visit_application.deptApproval }}" readonly>
                                    </div>
                                    <div class="col mb-2">
                                        <label class="form-label">HR Approval</label>
                                        <input type="text" class="form-control" value="{{ application.visit_application.HRApproval }}" readonly>
                                    </div>
                                    <div class="col mb-2">
                                        <label class="form-label">Final Approval</label>
                                        <input type="text" class="form-control" value="{{ application.visit_application.finalApproval }}" readonly>
                                    </div>
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label">Potential Scope</label>
                                        <textarea class="form-control" rows="2" name="potentialScope">{{ application.potentialScope }}</textarea>
                                    </div>
                                    <div class="mb-2">
                                    <label class="form-label">Note</label>
                                    <textarea class="form-control" rows="2" name="note">{{ application.note }}</textarea>
                                    </div>
                                    <div class="d-flex">
                                        <div class="my-2 ms-auto">
                                            <button type="submit" class="btn btn-dark btn-block">Submit</button>
                                        </div>
                                    </div>
                                </form>
                                </div>

                            </div>
                            </div>
                        </div>


                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="12" class="text-center">No visit applications found.</td>
                        </tr>

                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>



<!-- Apply Visit Modal -->
<div class="modal fade" id="applyVisitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/crm/addCustomerVisit">
                {% csrf_token %}
                <input type="hidden" name="apply_visit" value="1">
                <div class="modal-header">
                    <h5 class="modal-title">Apply for Visit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label>Visit To</label>
                    <select name="visitTo" id="visitTo" class="form-control" required>
                        {% for customer in customers %}
                        <option value="{{customer.id}}">{{customer.name}}</option>
                        {% endfor %}
                    </select>

                    <label>Customer Contact Person</label>
                    <select name="visitToAgent" id="visitToAgent" class="form-control" required>
                        {% for customer in customers %}
                        {% for agent in customer.agent.all %}
                        <option value="{{agent.id}}">{{agent.agent_name}}</option>
                        {% endfor %}
                        {% endfor %}
                    </select>

                    <label class="mt-3">Reason</label>
                    <textarea class="form-control" name="reason" required></textarea>

                    <label class="mt-3">Start Date</label>
                    <input type="datetime-local" class="form-control" name="startDate" required>

                    <label class="mt-3">End Date</label>
                    <input type="datetime-local" class="form-control" name="endDate" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/crm/addCustomer">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Add Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label>Customer Name</label>
                    <input type="text" class="form-control" name="name" required>

                    <label class="mt-3">Address</label>
                    <textarea class="form-control" name="address" required></textarea>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

