{% extends 'layout2.html' %}
{% block body %}
<style>
    .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 2;
        background-color: #f8f9fa;
    }
    .table th, .table td {
        padding-top: 0.3rem;
        padding-bottom: 0.3rem;
    }
</style>



<div class="container" style="margin-top: 80px; min-width: 1600px">
    <div class="d-flex mb-3">
      <form class="form d-flex flex-wrap" method="GET" action="">
        <!-- Search Input -->
        <input type="text" class="form-control mb-2 me-2"
               style="height: 40px; width: 380px;"
               name="search" placeholder="Search (Scope, Note...)"
               value="{{ request.GET.search }}">
    
        <!-- Customer Dropdown -->
        <select name="customer" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
            <option value="">All Customers</option>
            {% for c in customers %}
                <option value="{{ c.id }}" {% if request.GET.customer == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.name }}
                </option>
            {% endfor %}
        </select>
    
        <!-- Agent Dropdown -->
        <select name="agent" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
            <option value="">All Agents</option>
            {% for a in agents %}
                <option value="{{ a.id }}" {% if request.GET.agent == a.id|stringformat:"s" %}selected{% endif %}>
                    {{ a.agent_name }}
                </option>
            {% endfor %}
        </select>
    
        <!-- Employee Dropdown -->
        <select name="employee" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
            <option value="">All Employees</option>
            {% for e in employees %}
                <option value="{{ e.id }}" {% if request.GET.employee == e.id|stringformat:"s" %}selected{% endif %}>
                    {{ e.user.get_full_name }}
                </option>
            {% endfor %}
        </select>
    
        <!-- Date Filters -->
        <input type="date" name="start_date" class="form-control mb-2 me-2"
               style="height:40px; width: 180px"
               value="{{ request.GET.start_date }}">
        <input type="date" name="end_date" class="form-control mb-2 me-2"
               style="height:40px; width: 180px"
               value="{{ request.GET.end_date }}">
    
        <!-- Filter Button -->
        <button type="submit" class="btn btn-dark mb-2">Filter</button>
      </form>
      
    </div>

    <div class="table-container" style="max-height: 650px; overflow-y: auto;">
        <table class="table table-striped">
            <thead class="sticky-header">
                <tr>
                    <th>#</th>
                    <th>Offer Date</th>
                    <th>Customer</th>
                    <th>Generated By</th>
                    <th>Assigned To</th>
                    <th>Negotitaion Date</th>
                    <th>Offer Value</th>
                    <th>Target Price</th>
                    <th>Discount</th>
                    <th>Scope of Supply</th>
                    <th>Remarks</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for offer in offers %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ offer.offer_date }}</td>
                    {% if offer.lead.customerVisit %}
                    <td>{{ offer.lead.customerVisit.customer.name }}<br>
                        <span class="text-muted badge">{{ offer.lead.customerVisit.agent.agent_name }} - {{offer.lead.customerVisit.agent.agent_contact}}</span>
                    </td>
                    <td>{{ offer.lead.customerVisit.employee.user.get_full_name }}</td>
                    {% else %}
                    <td>{{ offer.lead.customer.name }}<br>
                      <span class="text-muted badge">{{ offer.agent.agent_name }} - {{offer.agent.agent_contact}}</span>
                    </td>
                    <td>{{ offer.lead.employee.user.get_full_name }}</td>
                    {% endif %}
                    <td>{{ offer.lead.assignedTo.user.get_full_name }}</td>
                    <td>{{ offer.negoDate }}</td>
                    <td>{{ offer.offerValue }}</td>
                    <td>{{ offer.tgtPrice }}</td>
                    <td>{{ offer.discount }}</td>
                    <td>{{ offer.lead.scopeOfSupply }}</td>
                    <td>{{ offer.note }}</td>
                    <td>
                        <button class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#editOfferModal{{ offer.id }}">
                            View
                        </button>
                        <button class="btn btn-sm btn-dark" data-bs-toggle="modal" data-bs-target="#pdfModal{{ offer.id }}">
                          <i class="fa-solid fa-file me-2"></i>
                          PDF
                        </button>
                    </td>
                </tr>
<!-- PDF Modal -->
<div class="modal fade" id="pdfModal{{ offer.id }}" tabindex="-1" aria-labelledby="pdfModalLabel{{ offer.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form method="POST" action="/crm/offers/generatePDF" id="pdfForm{{ offer.id }}">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="pdfModalLabel{{ offer.id }}">Generate PDF for Offer #{{ offer.id }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="offer_id" value="{{ offer.id }}">
          <input type="hidden" name="date" value="{{ today|date:'Y-m-d' }}">

          <div class="mb-3">
            <label for="title{{ offer.id }}" class="form-label">Title</label>
            <input type="text" class="form-control" name="title" id="title{{ offer.id }}" value="">
          </div>

          <div class="mb-3">
            <label for="customerEmployeePosition{{ offer.id }}" class="form-label">Customer Employee Position</label>
            <input type="text" class="form-control" name="customerEmployeePosition" id="customerEmployeePosition{{ offer.id }}" value="">
          </div>

          <div class="mb-3">
            <label for="proposals{{ offer.id }}" class="form-label">Proposal</label>
            <input type="text" class="form-control" name="proposals" id="proposals{{ offer.id }}" value="">
          </div>

          <div class="mb-3">
            <label for="reference{{ offer.id }}" class="form-label">Reference</label>
            <input type="text" class="form-control" name="reference" id="reference{{ offer.id }}" value="">
          </div>

          <div class="mb-3">
            <label for="limitingDate{{ offer.id }}" class="form-label">Limiting Date</label>
            <input type="date" class="form-control" name="limitingDate" id="limitingDate{{ offer.id }}" value="{{ today|date:'Y-m-d' }}">
          </div>

          <div class="mb-3">
            <label for="vat{{ offer.id }}" class="form-label">VAT (%)</label>
            <input type="number" class="form-control" name="vat" id="vat{{ offer.id }}">
          </div>

          <div class="mb-3">
            <label for="termsAndConditions{{ offer.id }}" class="form-label">Terms and Conditions</label>
            <textarea class="form-control" name="termsAndConditions" id="termsAndConditions{{ offer.id }}" rows="4"></textarea>
          </div>

          <hr>
          <h6>Products</h6>
          <div id="productsContainer{{ offer.id }}"></div>
          <button type="button" class="btn btn-sm btn-primary mt-2" onclick="addProductRow({{ offer.id }})">
            <i class="fa-solid fa-plus mb-1"></i> Add Product
          </button>
        </div>

        <input type="hidden" name="products_json" id="productsJson{{ offer.id }}">

        <div class="modal-footer">
          <button type="button" class="btn btn-success" onclick="submitPDFForm({{ offer.id }})">Save PDF Data</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function addProductRow(offerId) {
      const container = document.getElementById('productsContainer' + offerId);
  
      // Create product card div
      const card = document.createElement('div');
      card.className = 'card p-2 mb-2 productRow';
  
      // --- First row: only Product Name ---
      const row1 = document.createElement('div');
      row1.className = 'row g-2 align-items-center mb-2';
  
      var div = document.createElement('div');
      div.className = 'col-md-12';
      var input = document.createElement('input');
      input.type = 'text';
      input.name = 'name';
      input.placeholder = 'Product Name';
      input.className = 'form-control';
      div.appendChild(input);
      row1.appendChild(div);
  
      // --- Second row: Qty, Unit, Unit Price, Total + remove button ---
      const row2 = document.createElement('div');
      row2.className = 'row g-2 align-items-center';
  
      const secondFields = [
          ['Qty', 'quantity', 'col-md-2', 'number', 'productQty', 'oninput="calculateTotal(this)"'],
          ['Unit', 'unit', 'col-md-2'],
          ['Unit Price', 'unit_price', 'col-md-3', 'number', 'productUnitPrice', 'step="0.01" oninput="calculateTotal(this)"'],
          ['Total', 'total_price', 'col-md-3', 'number', 'productTotal', 'step="0.01" readonly']
      ];
  
      for (var i = 0; i < secondFields.length; i++) {
          var div = document.createElement('div');
          div.className = secondFields[i][2];
          var input = document.createElement('input');
          input.type = secondFields[i][3] || 'text';
          input.name = secondFields[i][1];
          input.placeholder = secondFields[i][0];
          input.className = 'form-control';
          if (secondFields[i][4]) input.className += ' ' + secondFields[i][4];
          if (secondFields[i][5]) input.setAttribute(secondFields[i][5].split('=')[0], secondFields[i][5].split('=')[1].replace(/"/g,''));
          div.appendChild(input);
          row2.appendChild(div);
      }
  
      // Remove button
      var removeDiv = document.createElement('div');
      removeDiv.className = 'col-md-2 d-flex align-items-center';
      var removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-sm btn-danger';
      removeBtn.innerHTML = '<i class="fa-solid fa-trash mb-1"></i>';
      removeBtn.onclick = function() {
          container.removeChild(card);
      };
      removeDiv.appendChild(removeBtn);
      row2.appendChild(removeDiv);
  
      // Append rows to card
      card.appendChild(row1);
      card.appendChild(row2);
      container.appendChild(card);
  }
  
  function calculateTotal(element) {
      var row = element.closest('.row');
      var qty = parseFloat(row.getElementsByClassName('productQty')[0].value) || 0;
      var price = parseFloat(row.getElementsByClassName('productUnitPrice')[0].value) || 0;
      row.getElementsByClassName('productTotal')[0].value = (qty * price).toFixed(2);
  }
  
  function submitPDFForm(offerId) {
      var form = document.getElementById('pdfForm' + offerId);
      if (!form) return;
  
      var container = document.getElementById('productsContainer' + offerId);
      if (!container) return;
  
      // Serialize products
      var rows = container.getElementsByClassName('productRow');
      var products = [];
  
      for (var i = 0; i < rows.length; i++) {
          var product = {};
          var inputs = rows[i].getElementsByTagName('input');
          for (var j = 0; j < inputs.length; j++) {
              if (inputs[j].name) product[inputs[j].name] = inputs[j].value;
          }
          products.push(product);
      }
  
      var hiddenInput = document.getElementById('productsJson' + offerId);
      hiddenInput.value = JSON.stringify(products);
  
      form.submit();
  }
  </script>
  
                <!-- Edit Offer Modal -->
<div class="modal fade" id="editOfferModal{{ offer.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form method="POST" action="/crm/editOffer/{{offer.id}}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Edit Offer #{{ forloop.counter }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
  
              <!-- Readonly Fields -->
              {% if offer.lead.customerVisit %}
              <div class="col-md-6">
                <label class="form-label">Customer</label>
                <input type="text" class="form-control" value="{{ offer.lead.customerVisit.customer.name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Agent</label>
                <input type="text" class="form-control" value="{{ offer.lead.customerVisit.agent.agent_name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Generated By</label>
                <input type="text" class="form-control" value="{{ offer.lead.customerVisit.employee.user.get_full_name }}" readonly>
              </div>
              {% else %}
              <div class="col-md-6">
                <label class="form-label">Customer</label>
                <input type="text" class="form-control" value="{{ offer.lead.customer.name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Agent</label>
                <input type="text" class="form-control" value="{{ offer.lead.agent.agent_name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Generated By</label>
                <input type="text" class="form-control" value="{{ offer.lead.employee.user.get_full_name }}" readonly>
              </div>
              {% endif %}
  
              <div class="col-md-6">
                <label class="form-label">Assigned To</label>
                <input type="text" class="form-control" value="{{ offer.lead.assignedTo.user.get_full_name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Offer Submission Date</label>
                <input type="date" class="form-control" value="{{ offer.offer_date|date:'Y-m-d' }}" readonly>
              </div>

              <div class="d-flex">
                <label class="form-label me-3">Relevant File from Lead</label>
                  {% if offer.lead.scopeFile %}
                      <a href="{{ offer.lead.scopeFile.url }}" target="_blank" class="btn btn-outline-dark btn-sm ms-1">
                          <i class="fa-solid fa-file mb-1"></i> Download Existing File
                      </a>
                  {% endif %} 
            </div>
            <div class="mb-2">
              <label class="form-label">Offer File</label>
              <div class="d-flex">
                <input type="file" name="offerFile" id="offerFile" class="form-control" style="max-width: 590px !important;">
                {% if offer.offerFile %}
                    <a href="{{ offer.offerFile.url }}" target="_blank" class="btn btn-outline-dark btn-sm ms-1">
                        <i class="fa-solid fa-file mb-1"></i> Download Existing File
                    </a>
                {% endif %}
              </div>
            </div>
  
              <!-- Editable Fields -->

              <div class="col-md-6">
                <label class="form-label">Target Price</label>
                <input type="number" name="tgtPrice" class="form-control" value="{{ offer.tgtPrice }}" required>
              </div>
              
              <div class="col-md-6">
                <label class="form-label">Offer Value</label>
                <input type="number" name="offerValue" class="form-control" value="{{ offer.offerValue }}" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Negotiation Date</label>
                <input type="date" name="negoDate" class="form-control" value="{{ offer.negoDate|date:'Y-m-d' }}" required>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Discount</label>
                <input type="number" step="0.01" name="discount" class="form-control" value="{{ offer.discount }}" required>
              </div>
  
              <div class="col-md-12">
                <label class="form-label">Scope of Supply</label>
                <textarea name="scopeOfSupply" class="form-control" rows="2" readonly>{{ offer.lead.scopeOfSupply }}</textarea>
              </div>

              <div class="col-md-12">
                <label class="form-label">Offer Status</label>
                <select name="status" class="form-select" required>
                  <option value="In Progress" {% if offer.status == "In Progress" %}selected{% endif %}>In Progress</option>
                  <option value="Submitted" {% if offer.status == "Submitted" %}selected{% endif %}>Submitted</option>
                  <option value="Not Submitted" {% if offer.status == "Not Submitted" %}selected{% endif %}>Not Submitted</option>
                  <option value="Under Negotiation" {% if offer.status == "Under Negotiation" %}selected{% endif %}>Under Negotiation</option>
                  <option value="On Hold" {% if offer.status == "On Hold" %}selected{% endif %}>On Hold</option>
                  <option value="Win" {% if offer.status == "Win" %}selected{% endif %}>Win</option>
                  <option value="Loss" {% if offer.status == "Loss" %}selected{% endif %}>Loss</option>
                </select>
              </div>
  
              <div class="col-md-12">
                <label class="form-label">Remarks</label>
                <textarea name="note" class="form-control" rows="2" required>{{ offer.note }}</textarea>
              </div>
  
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-dark">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>








                  

                {% empty %}
                <tr>
                    <td colspan="12" class="text-center">No offers found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>



{% endblock %}
