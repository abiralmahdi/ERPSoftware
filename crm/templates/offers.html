{% extends 'layout2.html' %}
{% block body %}
<style>
    .sticky-header th {
        position: sticky;
        top: 0;
        z-index: 2;
        background-color: #f8f9fa;
    }
    .table th, .table td {
        padding-top: 0.3rem;
        padding-bottom: 0.3rem;
    }
</style>



<div class="container" style="margin-top: 80px; min-width: 1600px">
    <div class="d-flex mb-3">
      <form class="form d-flex flex-wrap" method="GET" action="">
        <!-- Search Input -->
        <input type="text" class="form-control mb-2 me-2"
               style="height: 40px; width: 380px;"
               name="search" placeholder="Search (Scope, Note...)"
               value="{{ request.GET.search }}">
    
        <!-- Customer Dropdown -->
        <select name="customer" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
            <option value="">All Customers</option>
            {% for c in customers %}
                <option value="{{ c.id }}" {% if request.GET.customer == c.id|stringformat:"s" %}selected{% endif %}>
                    {{ c.name }}
                </option>
            {% endfor %}
        </select>
    
        <!-- Agent Dropdown -->
        <select name="agent" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
            <option value="">All Agents</option>
            {% for a in agents %}
                <option value="{{ a.id }}" {% if request.GET.agent == a.id|stringformat:"s" %}selected{% endif %}>
                    {{ a.agent_name }}
                </option>
            {% endfor %}
        </select>
    
        <!-- Employee Dropdown -->
        <select name="employee" class="form-select mb-2 me-2" style="height: 40px; width: 200px;">
            <option value="">All Employees</option>
            {% for e in employees %}
                <option value="{{ e.id }}" {% if request.GET.employee == e.id|stringformat:"s" %}selected{% endif %}>
                    {{ e.user.get_full_name }}
                </option>
            {% endfor %}
        </select>
    
        <!-- Date Filters -->
        <input type="date" name="start_date" class="form-control mb-2 me-2"
               style="height:40px; width: 180px"
               value="{{ request.GET.start_date }}">
        <input type="date" name="end_date" class="form-control mb-2 me-2"
               style="height:40px; width: 180px"
               value="{{ request.GET.end_date }}">
    
        <!-- Filter Button -->
        <button type="submit" class="btn btn-dark mb-2">Filter</button>
      </form>
    </div>

    <div class="table-container" style="max-height: 650px; overflow-y: auto;">
        <table class="table table-striped">
            <thead class="sticky-header">
                <tr>
                    <th>#</th>
                    <th>Offer Date</th>
                    <th>Customer</th>
                    <th>Generated By</th>
                    <th>Assigned To</th>
                    <th>Negotitaion Date</th>
                    <th>Target Price</th>
                    <th>Discount</th>
                    <th>Scope of Supply</th>
                    <th>Note</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for offer in offers %}
                <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>{{ offer.offer_date }}</td>
                    {% if offer.lead.customerVisit %}
                    <td>{{ offer.lead.customerVisit.customer.name }}<br>
                        <span class="text-muted badge">{{ offer.lead.customerVisit.agent.agent_name }} - {{offer.lead.customerVisit.agent.agent_contact}}</span>
                    </td>
                    <td>{{ offer.lead.customerVisit.employee.user.get_full_name }}</td>
                    {% else %}
                    <td>{{ offer.lead.customer.name }}</td>
                    <td>{{ offer.lead.agent.agent_name }}<br>
                        <span class="text-muted badge">{{ offer.agent.agent_name }} - {{offer.agent.agent_contact}}</span>
                    </td>
                    <td>{{ offer.lead.employee.user.get_full_name }}</td>
                    {% endif %}
                    <td>{{ offer.lead.assignedTo.user.get_full_name }}</td>
                    <td>{{ offer.negoDate }}</td>
                    <td>{{ offer.tgtPrice }}</td>
                    <td>{{ offer.discount }}</td>
                    <td>{{ offer.lead.scopeOfSupply }}</td>
                    <td>{{ offer.note }}</td>
                    <td>
                        <button class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#editOfferModal{{ offer.id }}">
                            View
                        </button>
                    </td>
                </tr>

                <!-- Edit Offer Modal -->
<div class="modal fade" id="editOfferModal{{ offer.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form method="POST" action="/crm/editOffer/{{offer.id}}" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title">Edit Offer #{{ forloop.counter }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
  
              <!-- Readonly Fields -->
              {% if offer.lead.customerVisit %}
              <div class="col-md-6">
                <label class="form-label">Customer</label>
                <input type="text" class="form-control" value="{{ offer.lead.customerVisit.customer.name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Agent</label>
                <input type="text" class="form-control" value="{{ offer.lead.customerVisit.agent.agent_name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Generated By</label>
                <input type="text" class="form-control" value="{{ offer.lead.customerVisit.employee.user.get_full_name }}" readonly>
              </div>
              {% else %}
              <div class="col-md-6">
                <label class="form-label">Customer</label>
                <input type="text" class="form-control" value="{{ offer.lead.customer.name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Agent</label>
                <input type="text" class="form-control" value="{{ offer.lead.agent.agent_name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Generated By</label>
                <input type="text" class="form-control" value="{{ offer.lead.employee.user.get_full_name }}" readonly>
              </div>
              {% endif %}
  
              <div class="col-md-6">
                <label class="form-label">Assigned To</label>
                <input type="text" class="form-control" value="{{ offer.lead.assignedTo.user.get_full_name }}" readonly>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Offer Submission Date</label>
                <input type="date" class="form-control" value="{{ offer.offer_date|date:'Y-m-d' }}" readonly>
              </div>

  
              <!-- Editable Fields -->
                
              <div class="col-md-6">
                <label class="form-label">Target Price</label>
                <input type="number" name="tgtPrice" class="form-control" value="{{ offer.tgtPrice }}" required>
              </div>

              <div class="col-md-6">
                <label class="form-label">Negotiation Date</label>
                <input type="date" name="negoDate" class="form-control" value="{{ offer.negoDate|date:'Y-m-d' }}" required>
              </div>
  
              <div class="col-md-6">
                <label class="form-label">Discount</label>
                <input type="number" step="0.01" name="discount" class="form-control" value="{{ offer.discount }}" required>
              </div>
  
              <div class="col-md-12">
                <label class="form-label">Scope of Supply</label>
                <textarea name="scopeOfSupply" class="form-control" rows="2" readonly>{{ offer.lead.scopeOfSupply }}</textarea>
              </div>
  
              <div class="col-md-12">
                <label class="form-label">Note</label>
                <textarea name="note" class="form-control" rows="2" required>{{ offer.note }}</textarea>
              </div>
  
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-dark">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  

                {% empty %}
                <tr>
                    <td colspan="12" class="text-center">No offers found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="addLeadModal" tabindex="-1" aria-labelledby="addLeadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" action="/crm/addLead">
          {% csrf_token %}
          <div class="modal-header">
            <h5 class="modal-title" id="addLeadModalLabel">Add New Lead</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="scopeOfSupply" class="form-label">Scope of Supply</label>
              <input type="text" class="form-control" id="scopeOfSupply" name="scopeOfSupply" required>
            </div>
            <div class="mb-3">
              <label for="status" class="form-label">Status</label>
              <select class="form-select" id="status" name="status" required>
                <option value="Open">Open</option>
                <option value="InProgress">In Progress</option>
                <option value="Closed">Closed</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Lead</button>
          </div>
        </form>
      </div>
    </div>
  </div>


{% endblock %}
