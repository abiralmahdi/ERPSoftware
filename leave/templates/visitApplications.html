{% extends 'layout.html' %}
{% block body %}
<div class="container mt-5" style="min-width: 1600px !important">
    <div class="d-flex mb-3 mt-5 pt-5">
        <form class="form d-flex me-auto" method="POST">
            {% csrf_token %}
            <input type="hidden" name="search_form" value="1">

            <input type="text" class="form-control" style="height: 40px; width: 500px;" name="employeeSearch" placeholder="Search employees...">

            <button type="submit" class="btn btn-dark ms-2">Search</button>

            <select name="department" class="btn btn-outline-dark ms-2" style="height: 40px;">
                <option value="">All Departments</option>
                {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                {% endfor %}
            </select>

            <select name="designation" class="btn btn-outline-dark ms-2" style="height: 40px;">
                <option value="">All Designations</option>
                {% for desig in designations %}
                    <option value="{{ desig.id }}">{{ desig.title }}</option>
                {% endfor %}
            </select>
        </form>
        <button class="btn btn-dark ms-auto" data-bs-toggle="modal" data-bs-target="#applyVisitModal"><i class="fa-solid fa-plus me-3"></i>Apply</button>
    </div>

    <div class="row">
        <div class="col-md-12 table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-striped table-hover">
                <thead class="table-light position-sticky top-0">
                    <tr>
                        <th>#</th>
                        <th>Employee Name</th>
                        <th>Department</th>
                        <th>Visit To</th>
                        <th>Apply Date</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Reason</th>
                        <th>Dept Approval</th>
                        <th>HR Approval</th>
                        <th>Final Approval</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    {% for application in visit_applications %}
                        <!-- Decline Modal -->
                        <div class="modal fade" id="declineModal{{ application.id }}" tabindex="-1">
                            <div class="modal-dialog">
                                <form method="POST" action="{% url 'declineVisit' application.id %}">
                                    {% csrf_token %}
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Decline Visit Application</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <label>Remarks</label>
                                            <textarea class="form-control" name="remarks" rows="3" required></textarea>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-danger btn-sm">Decline</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ application.employee.user.get_full_name }}</td>
                            <td>{{ application.employee.department.name }}</td>
                            <td>{{ application.visitTo }}</td>
                            <td>{{ application.applyDate }}</td>
                            <td>{{ application.startDate }}</td>
                            <td>{{ application.endDate }}</td>
                            <td>{{ application.reason }}</td>

                            <!-- Dept Approval -->
                            <td>
                                {% if request.user.employee.designation.level == 2 and request.user.employee.department.name != 'HR' %}
                                    {% if application.deptApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                    {% elif application.deptApproval == 'pending' %}
                                        <a class="btn-sm btn btn-success" href="{% url 'approveVisit' application.id %}"><i class="fa-solid fa-check"></i></a>
                                        <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                                {% elif request.user.employee.designation.level == 2 and request.user.employee.department.name == 'HR' %}
                                    {% if application.deptApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                    {% elif application.deptApproval == 'pending' %}
                                        <a class="btn-sm btn btn-success" href="{% url 'approveVisit' application.id %}"><i class="fa-solid fa-check"></i></a>
                                        <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                                {% else %}
                                    {% if application.deptApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                    {% elif application.deptApproval == 'pending' %}
                                        <span class="badge bg-warning">Pending</span><br>
                                        <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                                {% endif %}
                            </td>

                            <!-- HR Approval -->
                            <td>
                                {% if request.user.employee.department.name == 'HR' and application.deptApproval == 'approved' %}
                                    {% if application.HRApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                    {% elif application.HRApproval == 'pending' %}
                                        <a class="btn-sm btn btn-success" href="{% url 'approveVisit' application.id %}"><i class="fa-solid fa-check"></i></a>
                                        <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                                {% else %}
                                    {% if application.HRApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                    {% elif application.HRApproval == 'pending' %}
                                        <span class="badge bg-warning">Pending</span><br>
                                        <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                                {% endif %}
                            </td>

                            <!-- Final Approval -->
                            <td>
                                {% if request.user.is_superuser and application.deptApproval == 'approved' and application.HRApproval == 'approved' %}
                                    {% if application.finalApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                    {% elif application.finalApproval == 'pending' %}
                                        <a class="btn-sm btn btn-success" href="{% url 'approveVisit' application.id %}"><i class="fa-solid fa-check"></i></a>
                                        <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}">
                                            <i class="fa-solid fa-xmark"></i>
                                        </button>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                                {% else %}
                                    {% if application.finalApproval == 'approved' %}
                                        <span class="badge bg-success">Approved</span><br>
                                        <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                    {% elif application.finalApproval == 'pending' %}
                                        <span class="badge bg-warning">Pending</span><br>
                                        <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">Declined</span><br>
                                        <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                    {% endif %}
                                {% endif %}
                            </td>


                            <!-- Remarks -->
                            <td>
                                {% if application.remarks %}
                                    <span class="bg-light text-dark" style="font-size: smaller;">{{ application.remarks }}</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">No remarks</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="12" class="text-center">No visit applications found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Apply Visit Modal -->
<div class="modal fade" id="applyVisitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="apply_visit" value="1">
                <div class="modal-header">
                    <h5 class="modal-title">Apply for Visit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label>Visit To</label>
                    <input type="text" class="form-control" name="visitTo" required>

                    <label class="mt-3">Reason</label>
                    <textarea class="form-control" name="reason" required></textarea>

                    <label class="mt-3">Start Date</label>
                    <input type="date" class="form-control" name="startDate" required>

                    <label class="mt-3">End Date</label>
                    <input type="date" class="form-control" name="endDate" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
