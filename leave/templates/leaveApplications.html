{% extends 'layout.html' %}
{% block body %}

<style>
    /* Container fluid and padding on smaller widths */
@media (max-width: 1199px) {
  .container.mt-5 {
    min-width: unset !important;
    width: 100% !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    box-sizing: border-box;
  }
}

/* Form and buttons stack vertically on small devices */
@media (max-width: 575px) {
  .d-flex.mb-3.mt-5.pt-5 {
    flex-direction: column !important;
    gap: 10px;
  }
  .d-flex.mb-3.mt-5.pt-5 form.form.d-flex.me-auto input.form-control,
  .d-flex.mb-3.mt-5.pt-5 form.form.d-flex.me-auto select.btn,
  .d-flex.mb-3.mt-5.pt-5 form.form.d-flex.me-auto button.btn,
  .d-flex.mb-3.mt-5.pt-5 > button.btn-dark.ms-auto {
    width: 100% !important;
    max-width: 100% !important;
  }
  .d-flex.mb-3.mt-5.pt-5 > button.btn-dark.ms-auto {
    margin-top: 8px;
  }
}

/* Table container with constrained height and scroll on medium and small */
@media (max-width: 991px) {
  .table-responsive {
    max-height: 400px !important;
    overflow-y: auto !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  table.table {
    min-width: 900px;
    width: 100%;
    font-size: 0.9rem;
    table-layout: auto;
  }
  table.table th,
  table.table td {
    white-space: nowrap;
    padding: 0.35rem 0.5rem !important;
    vertical-align: middle;
  }
  thead.table-light.position-sticky.top-0 th {
    position: sticky !important;
    top: 0 !important;
    background-color: #f8f9fa !important;
    z-index: 10 !important;
  }
}

/* Further compaction on phones */
@media (max-width: 575px) {
  .table-responsive {
    max-height: 300px !important;
  }
  table.table {
    min-width: 600px;
    font-size: 0.85rem !important;
  }
  table.table th,
  table.table td {
    padding: 0.2rem 0.4rem !important;
  }
  .btn, .btn-dark {
    font-size: 0.8rem !important;
    padding: 0.25rem 0.5rem !important;
  }
}

</style>
<div class="container mt-5">
    <div class="d-flex mb-3 mt-5 pt-5">
        <form class="form d-flex me-auto" method="POST">
            {% csrf_token %}
            <input type="hidden" name="search_form" value="1">
            <!-- <h6 class="mt-2 me-3">Leave Applications</h6> -->
            <!-- Search Input -->
            <input type="text" class="form-control" style="height: 40px; width: 500px;" name="employeeSearch" placeholder="Search employees...">
    
            <!-- Search Button -->
            <button type="submit" class="btn btn-dark ms-2">Search</button>
    
            <!-- Department Dropdown -->
            <select name="department" class="btn btn-outline-dark ms-2" style="height: 40px;">
                <option class="bg-light text-dark" value="">All Departments</option>
                {% for dept in departments %}
                    <option value="{{ dept.id }}" {% if request.GET.department == dept.id|stringformat:"s" %}selected{% endif %} class="bg-light text-dark">
                        {{ dept.name }}
                    </option>
                {% endfor %}
            </select>
    
            <!-- Designation Dropdown -->
            <select name="designation" class="btn btn-outline-dark ms-2" style="height: 40px;">
                <option class="bg-light text-dark" value="">All Designations</option>
                {% for desig in designations %}
                    <option value="{{ desig.id }}" {% if request.GET.designation == desig.id|stringformat:"s" %}selected{% endif %} class="bg-light text-dark">
                        {{ desig.title }}
                    </option>
                {% endfor %}
            </select>
        </form>
        <button class="btn btn-dark ms-auto" data-bs-toggle="modal" data-bs-target="#addEmployeeModal"><i class="fa-solid fa-plus me-3"></i>Apply</button>
    </div>
    <div class="row">
        <div class="col-md-12 table-responsive" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-striped table-hover">
                <thead class="table-light position-sticky top-0">
                    <tr>
                        <th>#</th>
                        <th>Employee Name</th>
                        <th>Department</th>
                        <th>Duty Handover</th>
                        <th>Leave Type</th>
                        <th>Apply Date</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Reason</th>
                        <th>Dept Approval</th>
                        <th>HR Approval</th>
                        <th>Final Approval</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
                    {% for application in leave_applications %}
                    <!-- Decline Modal -->
                        <div class="modal fade" id="declineModal{{ application.id }}" tabindex="-1" aria-labelledby="declineModalLabel{{ application.id }}" aria-hidden="true">
                            <div class="modal-dialog">
                                <form method="POST" action="/leave/declineLeaveApplication/{{ application.id }}">
                                    {% csrf_token %}
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="declineModalLabel{{ application.id }}">Decline Leave Application</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label for="remarks{{ application.id }}" class="form-label">Remarks</label>
                                                <textarea class="form-control" id="remarks{{ application.id }}" name="remarks" rows="3" required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                                            <button type="submit" class="btn btn-danger btn-sm">Decline</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ application.employee.user.get_full_name }}</td>
                        <td>{{ application.employee.department.name }}</td>
                        <td>{{ application.dutyHandOver.user.get_full_name }}</td>
                        <td>{{ application.leaveType }}</td>
                        <td>{{ application.applyDate }}</td>
                        <td>{{ application.startDate }}</td>
                        <td>{{ application.endDate }}</td>
                        <td>{{ application.reason }}</td>
                        <td>
                            {% if request.user.employee.designation.level == 2 and request.user.employee.department.name != 'HR' %}
                                {% if application.deptApproval == 'approved' %}
                                <span class="badge bg-success">Approved</span><br> <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                {% elif application.deptApproval == 'pending' %}
                                <a class="btn-sm btn btn-success" href="/leave/approveLeaveApplication/{{application.id}}"><i class="fa-solid fa-check"></i></a>
                                <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}"><i class="fa-solid fa-xmark"></i></button>
                                {% else %}
                                <span class="badge bg-danger">Declined</span><br> <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                {% endif %}
                            {% elif request.user.employee.designation.level == 2 and request.user.employee.department.name == 'HR' %}
                                {% if application.deptApproval == 'approved' %}
                                <span class="badge bg-success">Approved</span><br> <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                {% elif application.deptApproval == 'pending' %}
                                <a class="btn-sm btn btn-success" href="/leave/approveLeaveApplication/{{application.id}}"><i class="fa-solid fa-check"></i></a>
                                <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}"><i class="fa-solid fa-xmark"></i></button>
                                {% else %}
                                <span class="badge bg-danger">Declined</span><br> <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                {% endif %}
                            {% else %}
                                {% if application.deptApproval == 'approved' %}
                                <span class="badge bg-success">Approved</span><br> <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                {% elif application.deptApproval == 'pending' %}
                                <span class="badge bg-warning">Pending</span><br> <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                {% else %}
                                <span class="badge bg-danger">Declined</span><br> <span class="text-muted badge">{{ application.deptApprovedBy.user.get_full_name }}</span>
                                {% endif %}
                            {% endif %}
                        </td>

                        <td>
                            {% if request.user.employee.department.name == 'HR' and application.deptApproval == 'approved' %}
                                {% if application.HRApproval == 'approved' %}
                                <span class="badge bg-success">Approved</span><br> <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                {% elif application.HRApproval == 'pending' %}
                                <a class="btn-sm btn btn-success" href="/leave/approveLeaveApplication/{{application.id}}"><i class="fa-solid fa-check"></i></a>
                                <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}"><i class="fa-solid fa-xmark"></i></button>
                                {% else %}
                                <span class="badge bg-danger">Declined</span><br> <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                {% endif %}
                            {% else %}
                                {% if application.HRApproval == 'approved' %}
                                <span class="badge bg-success">Approved</span><br> <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                {% elif application.HRApproval == 'pending' %}
                                <span class="badge bg-warning">Pending</span><br> <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                {% else %}
                                <span class="badge bg-danger">Declined</span><br> <span class="text-muted badge">{{ application.HRApprovedBy.user.get_full_name }}</span>
                                {% endif %}
                            {% endif %}

                        </td>

                        <td>
                            {% if request.user.is_superuser and application.deptApproval == 'approved' and application.HRApproval == 'approved' %}
                                {% if application.finalApproval == 'approved' %}
                                <span class="badge bg-success">Approved</span><br> <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                {% elif application.finalApproval == 'pending' %}
                                <a class="btn-sm btn btn-success" href="/leave/approveLeaveApplication/{{application.id}}"><i class="fa-solid fa-check"></i></a>
                                <button class="btn-sm btn btn-danger" data-bs-toggle="modal" data-bs-target="#declineModal{{ application.id }}"><i class="fa-solid fa-xmark"></i></button>
                                {% else %}
                                <span class="badge bg-danger">Declined</span><br> <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                {% endif %}
                            {% else %}
                                {% if application.finalApproval == 'approved' %}
                                <span class="badge bg-success">Approved</span><br> <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                {% elif application.finalApproval == 'pending' %}
                                <span class="badge bg-warning">Pending</span><br> <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                {% else %}
                                <span class="badge bg-danger">Declined</span><br> <span class="text-muted badge">{{ application.finalApprovedBy.user.get_full_name }}</span>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if application.remarks %}
                            <span class="bg-light text-dark" style="font-size: smaller;">{{ application.remarks }}</span>
                            {% else %}
                            <span class="badge bg-light text-dark">No remarks</span>
                            {% endif %}
                        </td>
                    </tr>
                    
                    {% empty %}
                    <tr>
                        <td colspan="11" class="text-center">No leave applications found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Apply Leave Modal -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addLeaveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST">
                {% csrf_token %}
                <input type="hidden" name="apply_leave" value="1">
                <div class="modal-header">
                    <h5 class="modal-title" id="addLeaveModalLabel">Apply for Leave</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body row">
                    <div class="col-md-6 mb-3">
                        <label for="dutyHandOver">Duty Handed Over To</label>
                        <select class="form-select" name="dutyHandOver" required>
                            {% for emp in employees %}
                            <option value="{{ emp.user.id }}">{{ emp.user.get_full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="leaveType">Leave Type</label>
                        <select name="leaveType" id="leaveType" class="form-control">
                            <option value="Casual Leave">Casual Leave</option>
                            <option value="Medical Leave">Medical Leave</option>
                            <option value="Annual Leave">Annual Leave</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="reason">Reason</label>
                        <input type="text" class="form-control" name="reason" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="startDate">Start Date</label>
                        <input type="date" class="form-control" name="startDate" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="endDate">End Date</label>
                        <input type="date" class="form-control" name="endDate" required>
                    </div>

                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold">Leave Balance:</h6>
                        <h6 class="fw-normal">Casual Leave: {{request.user.employee.casualLeave}}, Medical Leave: {{request.user.employee.medicalLeave}} </h6>
                        <h6 class="fw-normal">Annual Leave: {{request.user.employee.annualLeave}}, Other Leave:  {{request.user.employee.otherLeave}}</h6>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-dark">Submit Application</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
