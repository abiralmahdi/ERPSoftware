{% extends 'layout3.html' %}
{% block body %}

<div class="table-responsive" style="min-width: 1350px !important;">
    <table class="table table-striped">
        <thead class="sticky-header">
            <tr>
                <th>#</th>
                <th>Task Name</th>
                <th>Assigned To</th>
                <th>Assign Time</th>
                <th>Assigned By</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Deadline</th>
                <th>Progress</th>
                <th>
                  <!-- Add Task Button -->
                  <button type="button" class="ms-5 btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    + Add Task
                  </button>
                </th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <th scope="row">{{ forloop.counter }}</th>
                <td>{{ task.name }}</td>
                <td>{{ task.assignedTo.user.get_full_name }}</td>
                <td>{{ task.assignTime }}</td>
                <td>{{ task.createdBy.user.get_full_name }}</td>
                <td><span class="{% if task.status == 'Completed' %}text-primary fw-bold{% endif %}">{{ task.status }}</span></td>
                <td>{{ task.priority }}</td>
                <td>{{ task.deadline }}</td>
                <td>{{ task.progress }}%</td>
                <td>
                    <div class="d-flex">
                        <!-- Edit Button triggers modal -->
                        <button type="button" class="btn btn-sm btn-dark mx-1" data-bs-toggle="modal" data-bs-target="#editModal-{{ task.id }}">Edit</button>
                        <!-- Delete Button with confirmation -->
                        {% if request.user.is_superuser %}
                        <a href="/wms/projects/{{indivProject.id}}/tasks/{{task.id}}/delete" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this task?');">Delete</a>
                        {% else %}
                        <button class="btn btn-sm btn-danger" onclick="return alert('You are not authorized to delete a task.');">Delete</button>
                        {% endif %}
                        <!-- View history button -->
                        <a href="/wms/projects/{{indivProject.id}}/tasks/{{task.id}}/viewHistory" class="btn btn-sm btn-success mx-1">History</a>
                    </div>
                </td>
            </tr>

            <!-- Edit Modal -->
            <div class="modal fade" id="editModal-{{ task.id }}" tabindex="-1" aria-labelledby="editModalLabel-{{ task.id }}" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content">
                    <form method="post">
                      {% csrf_token %}
                      <input type="hidden" name="edit_task" value="1">
                      <input type="hidden" name="task_id" value="{{ task.id }}">
                      <div class="modal-header">
                        <h5 class="modal-title" id="editModalLabel-{{ task.id }}">Edit Task: {{ task.name }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label class="form-label">Task Name</label>
                            <input type="text" class="form-control" name="name" value="{{ task.name }}" required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Assigned To</label>
                            <select class="form-select" name="assignedTo">
                              {% for emp in employees %}
                                <option value="{{ emp.id }}" class="text-dark" {% if emp == task.assignedTo %}selected{% endif %}>
                                  {{ emp.user.get_full_name }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Assign Time</label>
                            <input type="datetime-local" class="form-control" name="assignTime" value="{{ task.assignTime|date:'Y-m-d\TH:i' }}" required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Deadline</label>
                            <input type="datetime-local" class="form-control" name="deadline" value="{{ task.deadline|date:'Y-m-d\TH:i' }}" required>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status" required>
                              <option value="Completed" {% if task.status == "Completed" %}selected{% endif %}>Completed</option>
                              <option value="Pending" {% if task.status == "Pending" %}selected{% endif %}>Pending</option>
                              <option value="In Progress" {% if task.status == "In Progress" %}selected{% endif %}>In Progress</option>
                            </select>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Priority</label>
                            <select class="form-select" name="priority" required>
                              <option value="High" {% if task.priority == "High" %}selected{% endif %}>High</option>
                              <option value="Medium" {% if task.priority == "Medium" %}selected{% endif %}>Medium</option>
                              <option value="Low" {% if task.priority == "Low" %}selected{% endif %}>Low</option>
                            </select>
                          </div>
                          <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description">{{ task.description }}</textarea>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label">Progress (%)</label>
                            <input type="number" class="form-control" name="progress" value="{{ task.progress }}" min="0" max="100">
                          </div>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
              

            {% endfor %}
        </tbody>
    </table>
</div>


<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" action="/wms/projects/{{indivProject.id}}/tasks/addTask">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">

            <!-- Task Name -->
            <div class="col-md-6">
              <label class="form-label">Task Name</label>
              <input type="text" name="name" class="form-control" required>
            </div>

            <!-- Assign To -->
            <div class="col-md-6">
              <label class="form-label">Assign To</label>
              <select name="assignedTo" class="form-select" required>
                <option value="">-- Select Employee --</option>
                {% for employee in employees %}
                  <option value="{{ employee.id }}">{{ employee.user.get_full_name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Assign Time -->
            <div class="col-md-6">
              <label class="form-label">Assign Time</label>
              <input type="datetime-local" name="assignTime" class="form-control" required>
            </div>

            <!-- Deadline -->
            <div class="col-md-6">
              <label class="form-label">Deadline</label>
              <input type="datetime-local" name="deadline" class="form-control" required>
            </div>

            <!-- Status -->
            <div class="col-md-6">
              <label class="form-label">Status</label>
              <select name="status" class="form-select" required>
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
              </select>
            </div>

            <!-- Priority -->
            <div class="col-md-6">
              <label class="form-label">Priority</label>
              <select name="priority" class="form-select" required>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
              </select>
            </div>

            <!-- Progress -->
            <div class="col-md-6">
              <label class="form-label">Progress (%)</label>
              <input type="number" name="progress" class="form-control" min="0" max="100" value="0" required>
            </div>

            <!-- Description -->
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea name="description" class="form-control" rows="3"></textarea>
            </div>

          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save Task</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}
