{% extends "layout3.html" %}
{% block body %}

<style>
  /* Container responsiveness */
@media (max-width: 1199px) {
  .container {
    width: 100% !important;
    min-width: unset !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    box-sizing: border-box;
  }
}

/* Responsive Gantt chart container */
#gantt {
  width: 100% !important;
  height: auto !important;
  min-height: 300px;
  max-width: 100%;
  overflow-x: auto;
}

/* Responsive table container with horizontal scroll */
.table-responsive {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

/* Table layout auto for responsiveness */
table.table {
  width: 100% !important;
  min-width: 600px;
  font-size: 0.9rem;
  table-layout: auto;
}

/* Prevent table cell wrapping */
table.table th,
table.table td {
  white-space: nowrap;
  padding: 0.3rem 0.5rem;
  vertical-align: middle;
}

/* Sticky header */
thead.table-light {
  position: sticky;
  top: 0;
  z-index: 3;
  background-color: #f8f9fa;
}

/* Compact on very small devices */
@media (max-width: 575px) {
  #gantt {
    min-height: 250px;
  }

  table.table {
    min-width: 450px;
    font-size: 0.85rem;
  }

  table.table th,
  table.table td {
    padding: 0.2rem 0.35rem;
  }
}

</style>

<div class="container">
  <h5 class="mb-4 mt-3">{{ indivProject.title }} - Timeline </h5>
  <div id="gantt" style="width: 1300px; min-height: 350px; margin-bottom: 40px;"></div>
  <div class="table-responsive">
    <table class="table table-sm table-striped table-hover mt-4">
      <thead class="table-light text-dark">
        <tr>
          <th scope="col">Task Name</th>
          <th scope="col">Start Date</th>
          <th scope="col">Deadline</th>
          <th scope="col">Progress (%)</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
        <tr>
          <td>{{ task.name }}</td>
          <td>{{ task.start }}</td>
          <td>{{ task.end }}</td>
          <td>{{ task.progress }}</td>
          <td>{{ task.status }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tasks = {{ tasks|safe }};

    google.charts.load('current', {'packages':['gantt']});
    google.charts.setOnLoadCallback(drawChart);

    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function darkenColor(hex, percent) {
        const num = parseInt(hex.slice(1),16),
              amt = Math.round(2.55 * percent),
              R = (num >> 16) - amt,
              G = (num >> 8 & 0x00FF) - amt,
              B = (num & 0x0000FF) - amt;
        return "#" + (
          0x1000000 + 
          (R<255?R<0?0:R:255)*0x10000 + 
          (G<255?G<0?0:G:255)*0x100 + 
          (B<255?B<0?0:B:255)
        ).toString(16).slice(1);
    }

    function drawChart() {
        const data = new google.visualization.DataTable();

        data.addColumn('string', 'Task ID');
        data.addColumn('string', 'Task Name');
        data.addColumn('string', 'Resource');
        data.addColumn('date', 'Start Date');
        data.addColumn('date', 'End Date');
        data.addColumn('number', 'Duration');
        data.addColumn('number', 'Percent Complete');
        data.addColumn('string', 'Dependencies');
        data.addColumn({ type: 'string', role: 'style' });

        tasks.forEach(task => {
            const start = new Date(task.start);
            const end = new Date(task.end);
            const color = getRandomColor();
            const darkColor = darkenColor(color, 30);
            const progress = task.progress || 0;

            // Single row with gradient fill
            const style = `fill-color: linear-gradient(to right, ${darkColor} ${progress}%, ${color} ${progress}% 100%);`;
            
            data.addRow([
                task.id,
                task.name,
                task.name,
                start,
                end,
                null,
                progress,
                task.dependencies || null,
                style
            ]);
        });

        const options = {
            width: 1300,
            height: Math.max(350, tasks.length * 40),  // minimum 350px, grows with tasks
            gantt: {
                barHeight: 15,
                trackHeight: 30,
                percentEnabled: true,
                labelStyle: { fontSize: 14 },
            }
        };

        const chart = new google.visualization.Gantt(document.getElementById('gantt'));
        chart.draw(data, options);
    }
});
</script>

{% endblock %}
